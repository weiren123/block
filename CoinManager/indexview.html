<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap Flat Registration Form Template</title>

    <!-- CSS -->
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:400,100,300,500">
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/bootstrap/css/font-awesome.min.css">
    <link rel="stylesheet" href="assets/css/form-elements.css">
    <link rel="stylesheet" href="assets/css/style.css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <!--<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>-->
    <!--<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>-->
    <![endif]-->

    <!-- Favicon and touch icons -->
    <!--<link rel="shortcut icon" href="assetsfile/ico/favicon.png">-->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="assetsfile/ico/apple-touch-icon-144-precomposed.png">-->
    <!--<link rel="apple-touch-icon-precomposed" sizes="114x114" href="assetsfile/ico/apple-touch-icon-114-precomposed.png">-->
    <!--<link rel="apple-touch-icon-precomposed" sizes="72x72" href="assetsfile/ico/apple-touch-icon-72-precomposed.png">-->
    <!--<link rel="apple-touch-icon-precomposed" href="assetsfile/ico/apple-touch-icon-57-precomposed.png">-->

</head>

<body>
<!-- Top content -->
<div class="top-content">
    <div class="inner-bg">
        <div class="container">
            <div class="row">

                <div class="col-sm-5 form-box">
                    <div class="form-top">
                        <div class="form-top-left">
                            <h3>记录您的币</h3>
                            <p>Record your digital assets:</p>
                        </div>
                        <div class="form-top-right">
                            <i class="fa fa-pencil"></i>
                        </div>
                        <div class="form-top-divider"></div>
                    </div>
                    <div class="form-bottom">
                        <!-- <form role="form" action="" method="post" class="registration-form">-->
                        <div class="form-group">
                            <label class="sr-only" for="form-first-name">币种</label>
                            <input type="text" name="form-first-name" placeholder="币种:BTC"
                                   class="form-first-name form-control input-error" id="form-first-name">
                        </div>
                        <div class="form-group">
                            <label class="sr-only" for="form-last-name">Last name</label>
                            <input type="text" name="form-last-name" placeholder="时间:2018-05-20"
                                   class="form-last-name form-control input-error" id="form-last-name">
                        </div>
                        <div class="form-group">
                            <label class="sr-only" for="form-email">Email</label>
                            <input type="text" name="form-email" placeholder="价格:$100"
                                   class="form-email form-control input-error" id="form-email">
                        </div>
                        <div class="form-group">
                            <label class="sr-only" for="form-about-yourself">About yourself</label>
                            <textarea name="form-about-yourself" placeholder="所在交易市场:火币"
                                      class="form-about-yourself form-control input-error"
                                      id="form-about-yourself"></textarea>
                            <input type="hidden" name="form-email" placeholder="价格"
                                   class="form-text form-control input-error">
                        </div>
                        <button type="" class="btn">记录</button>
                        <!-- </form>-->
                    </div>
                </div>
                <div class="col-sm-7 text">
                    <h1><strong>Coin</strong>
                        All  currency coin information
                    </h1>
                    <!--<div class="description">-->
                    <!--<p>-->
                    <!--This is a free responsive flat registration form made with Bootstrap.-->
                    <!--Download it on <a href="#"><strong>AZMIND</strong></a>, customize and use it as you like!-->
                    <!--</p>-->
                    <!--</div>-->
                    <div id="div1">

                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
<script src="assets/js/ins.js"></script>
<script src="assets/js/jquery-1.11.1.min.js"></script>
<!--[if lt IE 10]>
<!--<script src="assets/js/placeholder.js"></script>-->
<![endif]-->
<script src=lib/nebPay.js></script>
<script src="lib/nebulas.js"></script>

<div class="backstretch"
     style="left: 0px;top: 0px; overflow: hidden; margin: 0px; padding: 0px; height: 662px; width: 1528px; z-index: -999999; position: fixed;">

    <img src="assets/img/backgrounds/1.jpg"
         style="position: absolute; margin: 0px; padding: 0px; border: none; width: 1580px; height: 662px; max-height: none; max-width: none; z-index: -999999; left: -21.8333px; top: 0px;">
</div>
<script>
    "use strict";
    var CoinItem = function (text) {
        if (text) {
            var obj = JSON.parse(text);
            this.name = obj.name;
            this.time = obj.time;
            this.price = obj.price;
            this.place = obj.place;
        }
    };

    var dappContactAddress = "n1pGdc4YXVMLCQWwxQW1jGyeRYtC7TxTM93";
    var nebulas = require("nebulas"), Account = nebulas.Account, neb = new nebulas.Neb();
    neb.setRequest(new nebulas.HttpRequest("https://testnet.nebulas.io"))
    var NebPay = require("nebpay");     //https://github.com/nebulasio/nebPay
    var nebPay = new NebPay();
    var serialNumber;
    get("B");
    $(".btn").click(function () {
        var coinname = $(".form-first-name");
        var time = $(".form-last-name");
        var price = $(".form-email");
        var place = $(".form-about-yourself");
        var nameVal = coinname.val();
        var timeVal = time.val();
        var priceVal = price.val();
        var placeVal = place.val();

        var to = dappContactAddress;
        var value = "0";
        var callFunction = "save";
        var callArgs = "[\"" + nameVal + "\",\"" + timeVal + "\",\"" + priceVal + "\",\"" + placeVal + "\"]";
        var contract = {
            "function": callFunction,
            "args": callArgs,
        };
        serialNumber = nebPay.call(to, value, callFunction, callArgs, {    //使用nebpay的call接口去调用合约,
            listener: function (resp) {
                console.log("thecallback is " + resp);
                console.log(resp.result);
//                if (result == "" + nameVal + "") {
//                get(nameVal);
//                }
            }
        })
    })

    function get(nameVal) {
        var from = Account.NewAccount().getAddressString();
        var value = "0";
        var nonce = "0"
        var gas_price = "1000000"
        var gas_limit = "2000000"
        var callFunction = "get";
        var callArgs = "[\"" + nameVal + "\"]";
        var contract = {
            "function": callFunction,
            "args": callArgs,
        }
        neb.api.call(from, dappContactAddress, value, nonce, gas_price, gas_limit, contract).then(function (resp) {
            var result = resp.result;
            var v1 = JSON.parse(result);
            console.log(resp);
            console.log(v1);
            var arrs = new Array()
            for(i = 0;i<v1.length;i++){
                var coinInfo = new CoinItem();
                coinInfo.name = v1[i].name;
                coinInfo.time = v1[i].time;
                coinInfo.price = v1[i].price;
                coinInfo.place = v1[i].place;
                arrs.push(coinInfo)
            }
            addTable(arrs);
        }).catch(function (err) {
            console.log("error :" + err.message);
        })
    }

    function addTable(arrs) {
        var arrnsa = new Array();
        var arrss = new Array();
        for(i=0;i<arrs.length;i++){
            arrss[1] = arrs[i].name;
            arrss[2] = arrs[i].time;
            arrss[3] = arrs[i].price;
            arrss[4] = arrs[i].place;
        }


        var arrsname = new Array();
        arrsname[1] = "币种";
        arrsname[2] = "时间";
        arrsname[3] = "价格";
        arrsname[4] = "所在交易市场";
        var row1 = arrs.length + 1;//获取属性值
        var col1 = arrss.length - 1;//获取属性值
        var div1 = document.getElementById("div1");
        var tab = "<table border='1' bordercolor='#fff' width='500' height='30'>";
        //循环行
        for (var i = 1; i <= row1; i++) {
            tab += "<tr>";
            //循环列
            for (var j = 1; j <= col1; j++) {
                if (i == 1) {
                    tab += "<td>" + arrsname[j] + "</td>";
                } else {
                    tab += "<td>" + arrss[j] + "</td>";
                }
            }
            tab += "</tr>";
        }
        tab += "</table>"
        div1.innerHTML = tab;
    }
</script>
</body>
</html>